<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Instructor Schedule">
    <meta name="author" content="Josh Shirley">
    <title>Index</title>
    <style>
        body {
            width: 100vw;
            height: 100vh;
        }

        main {
            height: 100%;
        }

        .swipePad {
            width: 100%;
            min-height: 88vh;
            background-color: aliceblue;
            display: flex;
            border: 1px solid yellow;
        }
    </style>

</head>

<body>
    <header>
        <h1 class="title">Swiped</h1>
        <h3 class="link"></h3>
    </header>
    <main>

    </main>
    <footer>

    </footer>
    <script type="text/JavaScript" src="script/swiper.js"></script>
    <script type="text/JavaScript" src="script/URLcontroller.js"></script>"
    <script type="text/JavaScript" src="script/htmlbuilder.js"></script>
    <script type="text/JavaScript" src="script/errorView.js"></script>
    
    <script>

        function changeTitle(text) {
            var header = document.querySelector(".title");
            var link = document.querySelector(".link");
            if (text instanceof Date) {
                header.innerText = text.titleDate();
                link.innerText = text.toLocaleDateString().replaceAll("/", "-");
            }
            else {
                header.innerText = text;
            }
        }

        Date.prototype.titleDate = function () {
            return this.toLocaleDateString("default", { weekday: "long", month: "2-digit", day: "2-digit", year: "numeric" });
        };

        const pageLoad = {
            rolling: null,
            initiate: function (callback) {
                this.url = new URL(window.location.href);                
                this.params = new URLSearchParams(this.url.search);
                if (this.params.has("date")) {
                    this.rolling = this.tryParse(this.params.get("date"));
                    if (!this.rolling) {
                        errorDisplay.throw("Invalid Date", "Invalid date: " + this.rolling);
                    }
                    if(callback){
                        callback();
                    }
                }
                else {
                    // fresh params
                    let param = new URLSearchParams();
                    param.set("date", (new Date()).toISOString());

                    this.url.search = param;
                    // load up error on page so it doesn't loop
                    // window.location.href = url.toString();

                    // load an error
                    errorDisplay.throw("Data Error", "Not a valid date.");
                }
            },
            tryParse: function (datestring) {
                const date = new Date(datestring);
                if (isNaN(date.getTime())) {
                    errorDisplay.throw("Date Error", "Not a date.")
                    return null;
                } else {
                    return date;
                }
            },
            linkWithDate: function (date) {
                if (date instanceof Date) {
                    const params = new URLSearchParams();
                    params.append("date", this.zeroDate(date).toISOString());
                    pageLoad.url.search = "";
                    pageLoad.url.search = params;
                    return this.url.toString();
                }
                else {
                    throw "Error - not a date";
                }
            },
            zeroDate: function (date) {
                return new Date(date.getFullYear(), date.getMonth(), date.getDate());
            }
        }

        pageLoad.initiate(loadSwipe);
        
        // load the page detail      
        function loadSwipe() {
            // Page Titles
            changeTitle(pageLoad.rolling);

            // Swiper
            var assignments = { "right": swipeRight, "left": swipeLeft };
            swiper.initiate(document.querySelector("main"), assignments);
        }

        // SWIPE CONTROLS
        function swipeRight() {
            var previous = new Date(pageLoad.rolling.setDate(pageLoad.rolling.getDate() - 1));
            // FIX - change link
            window.location.assign("swiper.html?date=" + previous.toISOString());            
        }

        function swipeLeft() {
            var next = new Date(pageLoad.rolling.setDate(pageLoad.rolling.getDate() + 1));
            // FIX - change link 
            window.location.assign("swiper.html?date=" + next.toISOString());
        }



    </script>
</body>

</html>