<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Instructor Schedule">
    <meta name="author" content="Josh Shirley">
    <link rel="icon" type="image/x-icon" href="media/favicon.ico">
    <title>Schedule</title>
    <!-- Add in icon links -->

    <!-- Style Sheets -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

    <link rel="stylesheet" href="style/style.css?v=2">


    <!-- JavaScript links -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>

    <script src="script/URLcontroller.js"></script>
    <script>
        const check = new URLControl();
        if( !check.params.has("date") ){            
            window.location.href = check.link(new Date());
        }
    </script>
    <script src="script/swiper.js"></script>
    <script src="script/htmlbuilder.js"></script>
    <script src="script/errorView.js?v=1"></script>

    <script src="script/scheduleBlocks.js?v=1"></script>
    <script src="script/scheduleFetch.js?v=1"></script>
    <script src="script/calendar.js?v=1"></script>

</head>

<body class="d-flex flex-column min-vh-100">
    <header class="py-3 mb-3 border-bottom">
        <div class="container d-flex flex-wrap justify-content-between">
            <a href="/index.html" id="title-date" class="align-items-left mb-1 mb-md-0 me-md-auto fs-5" style="padding-top:4px;">
                Ski Gaupo
            </a>
            <ul class="nav nav-underline">
                <li class="nav-item"><a href="schedule.html" class="nav-link" aria-current="page">Schedule</a></li>
                <li class="nav-item"><a href="guests.html" class="nav-link active">Guests</a></li>
            </ul>
        </div>
    </header>
    <main>
        <div class="container-fluid" id="instructor">
            <div class="row headerRow pb-4">
                <div class="col-12"  class="showDate">
                </div>
                <div class="col-12">
                    Josh Shirley Canyons Village
                </div>
            </div>
        </div>

        <div class="container-fluid" id="content">

            <div class="accordion accordion-flush" id="scheduleAccordion">
                <div class="accordion-item mb-4">
                    <h2 class="accordion-header"><button class="accordion-button collapsed" type="button"
                            data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true"
                            aria-controls="collapseOne">
                            <div class="d-flex justify-content-between" style="width:100%;">
                                <div class="col text-start" data-type="start-end">8:30 AM - 4:00 PM</div>
                                <div class="col text-end" data-type="assignment">Nothing scheduled.</div>
                            </div>
                        </button></h2>
                    <div class="accordion-collapse collapse show" id="collapseOne">
                        <div class="accordion-body">
                            <h3>Off (Regular Day Off)</h3>
                            <p data-type="hours">Duration: 11 hours</p>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <div class="container">
            <div class="calendar" id="calendarView">
                <div id="calendarHolder"></div>
            </div>
        </div>

    </main>
    <footer class="mt-auto py-3 my-0">
        <div class="d-flex flex-wrap justify-content-center">
        </div>

        <ul class="nav justify-content-center mb-3">
            <li class="nav-item"><a href="schedule.html" class="nav-link px-2 text-body-light">Schedule</a></li>
            <li class="nav-item"><a href="settings.html" class="nav-link px-2 text-body-light">Settings</a></li>
            <li class="nav-item"><a href="guests.html" class="nav-link px-2 text-body-light">Guests</a></li>
        </ul>
        <p class="fs-0 small text-center text-info pb-0 mb-0">Â© 2024 Ski Gaupo, Inc</p>
    </footer>
    <script>

        const pageLoad = {
            rolling: null,
            initiate: function (callback) {
                this.url = new URL(window.location.href);
                this.params = new URLSearchParams(this.url.search);
                if (this.params.has("date")) {
                    this.rolling = this.tryParse(this.params.get("date"));
                    if (!this.rolling) {
                        errorDisplay.throw("Invalid Date", "Invalid date: " + this.rolling);
                    }
                    if (callback) {
                        callback();
                    }
                }
                else {
                    // fresh params
                    let param = new URLSearchParams();
                    param.set("date", (new Date()).toISOString());

                    this.url.search = param;
                    // load up error on page so it doesn't loop
                    // window.location.href = url.toString();

                    // load an error
                    errorDisplay.throw("Data Error", "Not a valid date.");
                }
            },
            tryParse: function (datestring) {
                const date = new Date(datestring);
                if (isNaN(date.getTime())) {
                    errorDisplay.throw("Date Error", "Not a date.")
                    return null;
                } else {
                    return date;
                }
            },
            linkWithDate: function (date) {
                if (date instanceof Date) {
                    const params = new URLSearchParams();
                    params.append("date", this.zeroDate(date).toISOString());
                    pageLoad.url.search = "";
                    pageLoad.url.search = params;
                    return this.url.toString();
                }
                else {
                    throw "Error - not a date";
                }
            },
            zeroDate: function (date) {
                return new Date(date.getFullYear(), date.getMonth(), date.getDate());
            }
        }

        pageLoad.initiate(thisPage);

        function thisPage() {

            // Update Titles and Date Strings
            document.querySelector("#title-date").innerText = pageLoad.rolling.toLocaleDateString("default", { weekday: "long", month: "2-digit", day: "2-digit", year: "numeric" });

            // Schedule Details
            schedule.initiate(pageLoad.rolling, confirm);            
                        
            // Calendar
            const calendar = new Calendar(pageLoad.rolling, new URLControl(), schedule.data);
            var calendarView = document.querySelector("#calendarHolder");
            calendarView.innerHTML = "";
            calendarView.append( builder(calendar.view()));

            // add in any schedule classes
            // can I move this into the calendar build?
            calendarSchedule(pageLoad.rolling.getMonth());
            
            // Swipe Controls
            loadSwipe();
        }

        function confirm() {
            console.log("confirmed");
        }

        function calendarSchedule(monthNumber) {
            // load the schedule
            const list = Object.keys(schedule.data);
            const keys = list.filter((key) => (new Date(key)).getMonth() == monthNumber);
            keys.forEach(key => {
                var activities = schedule.data[key];
                if (activities.length > 0) {
                    activities.forEach(activity => {
                        if (activity.hasOwnProperty("activity")) {

                            var description = activity["activity"].toLowerCase();

                            if (!description.includes("regular day off")) {

                                try {
                                    var dateString = (new Date(key)).toLocaleString("default", { month: "2-digit", day: "2-digit", year: "numeric" }).replaceAll("/", "-");
                                    var targetElement = document.querySelector("a[date='" + dateString + "']");
                                }
                                catch {
                                    console.log(dateString, " not found");
                                }

                                targetElement.classList.add("scheduled");

                                if (activity["assignment"].toLowerCase().includes("private request")) {
                                    // private request
                                    targetElement.classList.add("privateRequest");
                                }
                            }
                        }
                    });
                }
            });
        }        
        // load the page detail      
        function loadSwipe() {            
            // Swiper
            var assignments = { "right": swipeRight, "left": swipeLeft };
            // is it possible to constrict to content that is not .calendar
            swiper.initiate(document.querySelector("div#content"), assignments);

            // assign swiper commands to the calendar block as well.           
        }

        // SWIPE CONTROLS
        function swipeRight() {
            var previous = new Date(pageLoad.rolling.setDate(pageLoad.rolling.getDate() - 1));
            // FIX - change link
            //window.location.assign("swiper.html?date=" + previous.toISOString());            
            window.location.assign( (new URLControl(previous)).link() );
        }

        function swipeLeft() {
            var next = new Date(pageLoad.rolling.setDate(pageLoad.rolling.getDate() + 1));
            // FIX - change link 
            window.location.assign( (new URLControl(next)).link() );
        }
        
    </script>
</body>

</html>